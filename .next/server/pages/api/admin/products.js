"use strict";(()=>{var e={};e.id=5151,e.ids=[5151],e.modules={11185:e=>{e.exports=require("mongoose")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8731:(e,t,r)=>{r.r(t),r.d(t,{config:()=>p,default:()=>c,routeModule:()=>m});var a={};r.r(a),r.d(a,{default:()=>d});var i=r(71802),n=r(47153),s=r(56249),o=r(33087),u=r(46344),l=r(40122);async function d(e,t){let{method:r}=e;try{await (0,o.C)()}catch(e){return t.status(500).json({success:!1,message:e?.message||"Database connection failed"})}switch(r){case"GET":try{let r,a;let i=Math.max(parseInt(String(e.query.page||"1"),10)||1,1),n=Math.min(Math.max(parseInt(String(e.query.limit||"20"),10)||20,1),100),s=String(e.query.search||"").trim(),o=String(e.query.status||"all"),d={};if(o&&"all"!==o&&(d.status=o),s){let e=RegExp(s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i");d.$or=[{name:e},{brand:e},{sku:e}]}let c=`admin:products:${i}:${n}:${o}:${s}`,p=l.e.get(c);p?({items:r,total:a}=p,t.setHeader("X-Cache","HIT")):([r,a]=await Promise.all([u.x.find(d,"name brand price sale_price quantity status image created_at").sort({created_at:-1}).skip((i-1)*n).limit(n).lean(),u.x.countDocuments(d)]),l.e.set(c,{items:r,total:a},15e3),t.setHeader("X-Cache","MISS"));let m=i*n<a;return t.status(200).json({success:!0,data:r,paginatorInfo:{currentPage:i,total:a,hasNextPage:m,nextPageUrl:m?`page=${i+1}`:""}})}catch(e){return t.status(500).json({success:!1,message:"Error reading products"})}case"POST":try{let r=e.body,a=r.name.toLowerCase().replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"),i=a,n=1;for(;await u.x.exists({slug:i});)i=`${a}-${n++}`;let s=new Date,o=Array.isArray(r.images)?r.images:r.image?[r.image]:[],l=o[0]||"https://images.unsplash.com/photo-1592945403244-b3fbafd7f539?w=800&q=85",d=o.map((e,t)=>({id:t+1,thumbnail:e,original:e})),c=await u.x.create({name:r.name,description:r.description||"",short_description:r.short_description||"",slug:i,brand:r.brand,sku:r.sku||void 0,image:{id:1,thumbnail:l,original:l},gallery:d,price:Number.parseFloat(r.price)||0,sale_price:r.sale_price?Number.parseFloat(r.sale_price):null,category:r.category||"perfume",quantity:Number.parseInt(r.stock)||0,weight:r.weight||"",dimensions:r.dimensions||"",status:r.status||"active",featured:!!r.featured,meta_title:r.meta_title||r.name,meta_description:r.meta_description||r.description,tags:r.tags?String(r.tags).split(",").map(e=>e.trim()):[],variations:[{id:1,value:r.weight||"50ml",attribute:{id:1,name:"Size",slug:"size"}}],created_at:s,updated_at:s});return t.status(201).json({success:!0,data:c})}catch(r){let e=r?.code===11e3?"A product with this name already exists.":r?.message||"Error creating product";return t.status(500).json({success:!1,message:e})}default:return t.setHeader("Allow",["GET","POST"]),t.status(405).end(`Method ${r} Not Allowed`)}}let c=(0,s.l)(a,"default"),p=(0,s.l)(a,"config"),m=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/admin/products",pathname:"/api/admin/products",bundlePath:"",filename:""},userland:a})},33087:(e,t,r)=>{r.d(t,{C:()=>o});var a=r(11185),i=r.n(a);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable in .env.local");let s=global.__mongooseConn;async function o(){return s.conn||(s.promise||(s.promise=i().connect(n,{bufferCommands:!1,dbName:process.env.MONGODB_DB||"perfumify"})),s.conn=await s.promise),s.conn}s||(s=global.__mongooseConn={conn:null,promise:null})},40122:(e,t,r)=>{r.d(t,{e:()=>i});class a{get(e){let t=this.store.get(e);if(t){if(Date.now()>t.expiry){this.store.delete(e);return}return t.value}}set(e,t,r){this.store.set(e,{value:t,expiry:Date.now()+r})}del(e){this.store.delete(e)}constructor(){this.store=new Map}}let i=new a},46344:(e,t,r)=>{r.d(t,{x:()=>o});var a=r(11185),i=r.n(a);let n=new a.Schema({url:{type:String,required:!0},public_id:{type:String,required:!0},width:{type:Number},height:{type:Number}},{_id:!1}),s=new a.Schema({name:{type:String,required:!0},slug:{type:String,required:!0,unique:!0},description:{type:String},shipping_policy:{type:String},refund_policy:{type:String},sale_price:{type:Number},price:{type:Number,required:!0},images:{type:[n],default:[]},category:{type:String,required:!0},categories:{type:[String],default:[]},brand:{type:String,required:!0},gender:{type:String,enum:["men","women","unisex"],default:"unisex"},stock:{type:Number,default:0},sku:{type:String,unique:!0,sparse:!0},weight:{type:Number},tags:[String],variations:Object,bestSeller:{type:Boolean,default:!1},newArrival:{type:Boolean,default:!1},featured:{type:Boolean,default:!1}},{timestamps:!0}),o=i().models.Product||i().model("Product",s)},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8731);module.exports=r})();